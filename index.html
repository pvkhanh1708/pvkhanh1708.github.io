<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tr√¨nh so·∫°n & ph√°t giai ƒëi·ªáu - Thu·∫ßn HTML/CSS/JS</title>
    <style>
        :root {
            --bg: #0b0f14;
            --card: #121824;
            --muted: #6b7280;
            --text: #e5e7eb;
            --accent: #60a5fa;
            --ok: #34d399;
            --warn: #f59e0b;
            --danger: #f87171;
            --chip: #1f2937;
            --chip-on: #374151;
            --border: #223047;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: linear-gradient(180deg, #0b0f14, #0a1220 60%, #0b0f14);
            color: var(--text)
        }

        header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: #0c1422;
            position: sticky;
            top: 0;
            z-index: 5
        }

        header h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: .2px
        }

        .wrap {
            max-width: 1100px;
            margin: 24px auto;
            padding: 0 16px;
            display: grid;
            gap: 16px;
            grid-template-columns: 340px 1fr
        }

        @media (max-width:900px) {
            .wrap {
                grid-template-columns: 1fr
            }
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 10px 30px #0006
        }

        .panel h2 {
            margin: 6px 0 10px;
            font-size: 15px;
            color: #b9c2d3;
            font-weight: 600
        }

        .row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin: 8px 0
        }

        .label {
            font-size: 12px;
            color: var(--muted);
            min-width: 64px
        }

        .btn,
        button {
            appearance: none;
            border: 1px solid var(--border);
            background: var(--chip);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px
        }

        .btn:hover {
            background: var(--chip-on)
        }

        .btn.is-on {
            outline: 2px solid var(--accent);
            background: #213046
        }

        .btn.small {
            padding: 6px 10px;
            font-size: 12px
        }

        .btn.primary {
            background: #1d2a40;
            border-color: #2b3b59
        }

        .btn.green {
            background: #113323;
            border-color: #1d4836
        }

        .btn.red {
            background: #36171a;
            border-color: #5a2328
        }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .chip {
            background: var(--chip);
            border: 1px dashed var(--border);
            padding: 8px 10px;
            border-radius: 999px;
            font-size: 13px;
            display: inline-flex;
            gap: 8px;
            align-items: center
        }

        .chip .x {
            cursor: pointer;
            opacity: .7
        }

        .chip.playing {
            outline: 2px solid var(--ok)
        }

        .score {
            min-height: 82px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: radial-gradient(ellipse at 50% -60%, #20304c44, transparent 60%), linear-gradient(#182133, #111827);
            padding: 12px;
            overflow: auto
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .spacer {
            flex: 1
        }

        input[type="number"],
        select {
            background: var(--chip);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 10px
        }

        .help {
            font-size: 12px;
            color: #9aa6ba
        }

        .kbd {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
            background: #0f172a;
            border: 1px solid #1e293b;
            border-radius: 6px;
            padding: 1px 6px
        }

        footer {
            opacity: .7;
            font-size: 12px;
            padding: 12px 20px
        }
    </style>
</head>

<body>
    <header>
        <h1>üéº Tr√¨nh so·∫°n & ph√°t giai ƒëi·ªáu (HTML/CSS/JS thu·∫ßn)</h1>
    </header>

    <div class="wrap">
        <!-- B√äN TR√ÅI: ƒêi·ªÅu khi·ªÉn ch·ªçn n·ªët -->
        <section class="panel" aria-label="Ch·ªçn tham s·ªë n·ªët">
            <h2>1) Ch·ªçn n·ªët v√† s·∫Øc th√°i</h2>

            <div class="row">
                <span class="label">N·ªët:</span>
                <div class="chips" id="noteRow"></div>
            </div>

            <div class="row">
                <span class="label">Ho√°:</span>
                <div class="chips" id="accRow"></div>
            </div>

            <div class="row">
                <span class="label">Tr∆∞·ªùng ƒë·ªô:</span>
                <div class="chips" id="durRow"></div>
            </div>

            <div class="row">
                <span class="label">B·∫≠c (qu√£ng t√°m):</span>
                <div class="chips" id="octRow"></div>
            </div>

            <div class="row">
                <span class="label">Tempo:</span>
                <input id="bpm" type="number" min="40" max="220" step="1" value="120" /> BPM
            </div>

            <div class="row toolbar">
                <button id="btnAdd" class="btn primary">+ Th√™m v√†o b·∫£n nh·∫°c</button>
                <button id="btnRest" class="btn">+ Th√™m ngh·ªâ (Rest)</button>
                <span class="spacer"></span>
                <button id="btnUndo" class="btn">‚Ü∂ B·ªè n·ªët cu·ªëi</button>
                <button id="btnClear" class="btn red">üóë Xo√° t·∫•t c·∫£</button>
            </div>

            <p class="help">M·∫πo: b·∫•m ph√≠m <span class="kbd">1-7</span> ƒë·ªÉ ch·ªçn n·ªët C‚ÜíB, <span class="kbd">Q/W/E</span> =
                ‚ô≠/‚ôÆ/‚ôØ, <span class="kbd">A/S/D/F/G</span> = tr√≤n/tr·∫Øng/ƒëen/ƒë∆°n/ƒë√¥i, <span class="kbd">4/5/6</span> =
                b·∫≠c, <span class="kbd">Enter</span> ƒë·ªÉ th√™m.</p>
        </section>

        <!-- B√äN PH·∫¢I: B·∫£n nh·∫°c v√† ph√°t -->
        <section class="panel" aria-label="B·∫£n nh·∫°c v√† ph√°t">
            <h2>2) B·∫£n nh·∫°c</h2>
            <div id="score" class="score"></div>

            <div class="row toolbar" style="margin-top:12px">
                <button id="btnPlay" class="btn green">‚ñ∂ Ph√°t</button>
                <button id="btnStop" class="btn">‚èπ D·ª´ng</button>
                <span class="spacer"></span>
                <button id="btnCopy" class="btn small">üìã Sao ch√©p JSON</button>
                <button id="btnLoad" class="btn small">üì• N·∫°p JSON</button>
            </div>
        </section>
    </div>


    <script>
        // ====== C·∫§U H√åNH ======
        const NOTES = ["C", "D", "E", "F", "G", "A", "B"]; // 1..7
        const ACCS = [
            { id: "flat", label: "‚ô≠ (b)", v: -1 },
            { id: "nat", label: "‚ôÆ (th∆∞·ªùng)", v: 0 },
            { id: "sharp", label: "‚ôØ (#)", v: +1 }
        ];
        const DURS = [
            { id: "wh", label: "tr√≤n", frac: 4 },   // whole = 4 beats (4/4)
            { id: "ha", label: "tr·∫Øng", frac: 2 },
            { id: "qu", label: "ƒëen", frac: 1 },
            { id: "ei", label: "ƒë∆°n", frac: 0.5 },
            { id: "si", label: "ƒë√¥i", frac: 0.25 }
        ];
        const OCTS = [4, 5, 6];

        // ====== STATE ch·ªçn hi·ªán t·∫°i ======
        let selNote = "C";
        let selAcc = 0;
        let selDur = 1; // quarter
        let selOct = 4;
        let score = []; // m·∫£ng c√°c ph·∫ßn t·ª≠: {type:'note', note:'C', acc:0, oct:4, dur:1} | {type:'rest', dur:1}

        // ====== RENDER c√°c nh√≥m n√∫t ch·ªçn ======
        const noteRow = document.getElementById('noteRow');
        const accRow = document.getElementById('accRow');
        const durRow = document.getElementById('durRow');
        const octRow = document.getElementById('octRow');
        const bpmEl = document.getElementById('bpm');
        const scoreEl = document.getElementById('score');

        function mkBtn(text, onClick) {
            const b = document.createElement('button'); b.className = 'btn'; b.textContent = text; b.onclick = onClick; return b;
        }

        // Notes C..B
        NOTES.forEach(n => {
            const b = mkBtn(n, () => { selNote = n; refreshActives(); });
            b.dataset.note = n; noteRow.appendChild(b);
        });
        // Accidentals
        ACCS.forEach(a => {
            const b = mkBtn(a.label, () => { selAcc = a.v; refreshActives(); });
            b.dataset.acc = a.v; accRow.appendChild(b);
        });
        // Durations
        DURS.forEach(d => {
            const b = mkBtn(d.label, () => { selDur = d.frac; refreshActives(); });
            b.dataset.dur = d.frac; durRow.appendChild(b);
        });
        // Octaves
        OCTS.forEach(o => {
            const b = mkBtn(String(o), () => { selOct = o; refreshActives(); });
            b.dataset.oct = o; octRow.appendChild(b);
        });

        function refreshActives() {
            [...noteRow.children].forEach(b => b.classList.toggle('is-on', b.dataset.note === selNote));
            [...accRow.children].forEach(b => b.classList.toggle('is-on', Number(b.dataset.acc) === selAcc));
            [...durRow.children].forEach(b => b.classList.toggle('is-on', Number(b.dataset.dur) === selDur));
            [...octRow.children].forEach(b => b.classList.toggle('is-on', Number(b.dataset.oct) === selOct));
        }
        refreshActives();

        // ====== S·ª∞ KI·ªÜN TH√äM/XO√Å ======
        document.getElementById('btnAdd').onclick = () => {
            score.push({ type: 'note', note: selNote, acc: selAcc, oct: selOct, dur: selDur });
            renderScore();
        };
        document.getElementById('btnRest').onclick = () => {
            score.push({ type: 'rest', dur: selDur });
            renderScore();
        };
        document.getElementById('btnUndo').onclick = () => { score.pop(); renderScore(); };
        document.getElementById('btnClear').onclick = () => { score.length = 0; renderScore(); };

        // ====== HI·ªÇN TH·ªä B·∫¢N NH·∫†C ======
        function renderScore() {
            scoreEl.innerHTML = '';
            if (score.length === 0) { scoreEl.innerHTML = '<span class="help">(Ch∆∞a c√≥ g√¨. H√£y ch·ªçn n·ªët v√† b·∫•m ‚ÄúTh√™m‚Äù.)</span>'; return; }
            score.forEach((it, idx) => {
                const chip = document.createElement('span'); chip.className = 'chip'; chip.dataset.idx = idx;
                const lab = it.type === 'note' ? labelOf(it) : `Rest ${durText(it.dur)}`;
                chip.innerHTML = `<strong>${lab}</strong> <span class="x" title="Xo√°">‚úï</span>`;
                chip.querySelector('.x').onclick = () => { score.splice(idx, 1); renderScore(); };
                scoreEl.appendChild(chip);
            });
        }

        function labelOf(n) {
            const acc = n.acc === -1 ? '‚ô≠' : n.acc === 1 ? '‚ôØ' : '‚ôÆ';
            return `${n.note}${acc}${n.oct} ¬∑ ${durText(n.dur)}`;
        }
        function durText(frac) {
            const d = DURS.find(x => x.frac === frac); return d ? d.label : `${frac} ph√°ch`;
        }

        // ====== WEB AUDIO PLAYBACK ======
        let actx = null; let nowPlaying = false; let stopFlag = false; let liveNodes = [];

        function getCtx() { if (!actx) actx = new (window.AudioContext || window.webkitAudioContext)(); return actx; }

        function midiOf(note, acc, oct) {
            // Map C=0 .. B=11
            const baseIdx = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 }[note];
            const semis = baseIdx + acc + (oct + 1) * 12; // MIDI number like A4=69
            return semis;
        }
        function freqFromMidi(m) { return 440 * Math.pow(2, (m - 69) / 12); }

        function scheduleScore() {
            if (score.length === 0) return;
            const ctx = getCtx();
            stopFlag = false; nowPlaying = true; liveNodes = [];
            const bpm = Math.max(40, Math.min(220, Number(bpmEl.value) || 120));
            const secPerBeat = 60 / bpm;
            let t = ctx.currentTime + 0.05; // nh·ªè ƒë·ªÉ tr√°nh click

            // clear playing highlight
            [...scoreEl.querySelectorAll('.chip')].forEach(ch => ch.classList.remove('playing'));

            score.forEach((it, idx) => {
                const durSec = (it.dur) * secPerBeat; // 4/4: tr√≤n=4 beat
                if (it.type === 'rest') {
                    // ch·ªâ im l·∫∑ng: ƒë·∫∑t m·ªôt timeout ƒë·ªÉ highlight
                    cueHighlight(idx, t, durSec);
                    t += durSec; return;
                }
                const f = freqFromMidi(midiOf(it.note, it.acc, it.oct));
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = f;
                gain.gain.setValueAtTime(0.001, t);
                gain.gain.linearRampToValueAtTime(0.35, t + 0.01);
                // envelope ra
                const end = t + durSec;
                gain.gain.setValueAtTime(0.35, end - 0.04);
                gain.gain.linearRampToValueAtTime(0.0001, end);

                osc.connect(gain).connect(ctx.destination);
                osc.start(t);
                osc.stop(end + 0.01);
                liveNodes.push(osc); // d√πng ƒë·ªÉ stop s·ªõm

                cueHighlight(idx, t, durSec);
                t = end;
            });

            // auto stop khi xong
            const totalDur = t - ctx.currentTime;
            setTimeout(() => { nowPlaying = false; }, Math.ceil(totalDur * 1000) + 30);
        }

        function cueHighlight(idx, t, dur) {
            const ch = scoreEl.querySelector(`.chip[data-idx="${idx}"]`);
            if (!ch) return;
            const ctx = getCtx();
            const msStart = Math.max(0, (t - ctx.currentTime) * 1000);
            const msEnd = Math.max(0, (t + dur - ctx.currentTime) * 1000);
            setTimeout(() => ch.classList.add('playing'), msStart);
            setTimeout(() => ch.classList.remove('playing'), msEnd);
        }

        // PLAY/STOP
        document.getElementById('btnPlay').onclick = () => {
            if (nowPlaying) return; // ƒëang ph√°t r·ªìi
            scheduleScore();
        };
        document.getElementById('btnStop').onclick = stopPlayback;

        function stopPlayback() {
            if (!actx) return; nowPlaying = false; stopFlag = true;
            try { liveNodes.forEach(n => { try { n.stop(); } catch { } }); } catch { }
            liveNodes.length = 0;
            // b·ªè highlight
            [...scoreEl.querySelectorAll('.chip')].forEach(ch => ch.classList.remove('playing'));
        }

        // ====== KBD SHORTCUTS ======
        document.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const k = e.key.toLowerCase();
            if ('1234567'.includes(k)) {
                selNote = NOTES[Number(k) - 1]; refreshActives();
            } else if (k === 'q') { selAcc = -1; refreshActives(); }
            else if (k === 'w') { selAcc = 0; refreshActives(); }
            else if (k === 'e') { selAcc = +1; refreshActives(); }
            else if (k === 'a') { selDur = 4; refreshActives(); }
            else if (k === 's') { selDur = 2; refreshActives(); }
            else if (k === 'd') { selDur = 1; refreshActives(); }
            else if (k === 'f') { selDur = 0.5; refreshActives(); }
            else if (k === 'g') { selDur = 0.25; refreshActives(); }
            else if (k === '4') { selOct = 4; refreshActives(); }
            else if (k === '5') { selOct = 5; refreshActives(); }
            else if (k === '6') { selOct = 6; refreshActives(); }
            else if (e.key === 'Enter') {
                score.push({ type: 'note', note: selNote, acc: selAcc, oct: selOct, dur: selDur });
                renderScore();
            }
        });

        // ====== XU·∫§T / N·∫†P JSON ======
        document.getElementById('btnCopy').onclick = () => {
            const data = JSON.stringify({ bpm: Number(bpmEl.value) || 120, items: score }, null, 2);
            navigator.clipboard.writeText(data).then(() => {
                toast('ƒê√£ sao ch√©p JSON v√†o Clipboard!');
            });
        };

        document.getElementById('btnLoad').onclick = () => {
            const s = prompt('D√°n JSON (ƒë·ªãnh d·∫°ng {bpm, items}) v√†o ƒë√¢y:');
            if (!s) return;
            try {
                const obj = JSON.parse(s);
                if (obj.bpm) bpmEl.value = obj.bpm;
                if (Array.isArray(obj.items)) score = obj.items.filter(v => v && (v.type === 'note' || v.type === 'rest'));
                renderScore();
                toast('ƒê√£ n·∫°p JSON.');
            } catch (err) { toast('JSON kh√¥ng h·ª£p l·ªá.'); }
        };

        function toast(msg) {
            const t = document.createElement('div');
            t.textContent = msg;
            t.style.position = 'fixed'; t.style.bottom = '18px'; t.style.right = '18px'; t.style.padding = '10px 12px'; t.style.background = '#0b172a';
            t.style.border = '1px solid #203049'; t.style.borderRadius = '10px'; t.style.boxShadow = '0 10px 30px #0008';
            document.body.appendChild(t); setTimeout(() => t.remove(), 1600);
        }

        // l·∫ßn ƒë·∫ßu
        renderScore();
    </script>
</body>

</html>